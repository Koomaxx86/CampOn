<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace="매퍼 인터페이스 경로" -->
<mapper namespace="com.camp.campon.mapper.CampMapper">

    <!-- 캠프 목록 -->
    <select id="list" resultType="Camp">
        SELECT * 
        FROM campproduct
    </select>
    
    <select id="cpdtlist" resultType="Camp">
        SELECT *
        FROM campdetail
    </select>

    <select id="campSelect" resultType="Camp">
        SELECT *
        FROM campproduct c
        JOIN campdetail cd ON c.camp_no = cd.camp_no
        JOIN camptype ct ON cd.camptype_no = ct.camptype_no
        JOIN campimg img ON c.camp_no = img.camp_no 
        JOIN (SELECT min(cpi_no) no FROM campimg GROUP BY camp_no) imgno ON img.cpi_no = imgno.no
        WHERE ct.camptype_no = #{campTypeNo}
        ORDER BY c.camp_no DESC;
    </select>
    
    <!-- 캠프 최신목록 -->
    <select id="newList" resultType="Camp">
        SELECT * 
        FROM campproduct c 
        join campimg img on c.camp_no = img.camp_no 
        join (select min(cpi_no) no from campimg group by camp_no) imgno on img.cpi_no = imgno.no
        order by c.reg_date desc limit 6
    </select>
    
    <!-- 캠프 추천목록 -->
    <select id="hotList" resultType="Camp">
        SELECT * 
        FROM campproduct c 
        join campimg img on c.camp_no = img.camp_no 
        join (select min(cpi_no) no from campimg group by camp_no) imgno on img.cpi_no = imgno.no
        join (select camp_no, count(*) c from reservation group by camp_no) r on c.camp_no = r.camp_no
        order by r.c desc limit 6
    </select>

    <!-- 캠핑 타입 목록 -->
    <select id="camptype" resultType="Camp">
        SELECT *
        FROM camptype
    </select>

    <!-- 캠핑장 등록 -->
    <insert id="campInsert">
        INSERT INTO 
        campproduct ( 
                        region_no, user_no, camp_name, camp_address, camp_tel, camp_location, camp_layout, camp_open, camp_close, camp_period, camp_introduction, camp_caution
                    )
        VALUES ( 
                #{regionNo}, #{userNo}, #{campName}, #{campAddress}, #{campTel}, #{campLocation}, #{campLayout}, #{campOpen}, #{campClose}, #{campPeriod}, #{campIntroduction}, #{campCaution} 
               )
    </insert>

    <!-- 캠핑장 이미지파일 등록 -->
    <insert id="campImgInsert">
        INSERT INTO
        campimg ( camp_no, cpi_url )
        VALUES ( #{campNo}, #{cpiUrl} )
    </insert>

    <!-- 캠핑장 시설물 등록 -->
    <insert id="campFacilityInsert">
        INSERT INTO
        facility ( camp_no, facilitytype_no )
        VALUES ( #{campNo}, #{facilitytypeNo} )
    </insert>

    <!-- 캠핑장 환경 등록 -->
    <insert id="campEnvironmentInsert">
        INSERT INTO
        environment ( camp_no, environmenttype_no )
        VALUES ( #{campNo}, #{environmentTypeNo} )
    </insert>

    <!-- 캠핑장목록(판매자) -->
    <select id="campproductUser" resultType="Camp">
        SELECT *
        FROM campproduct c
        JOIN campimg img ON c.camp_no = img.camp_no 
        JOIN (SELECT min(cpi_no) no FROM campimg GROUP BY camp_no) imgno ON img.cpi_no = imgno.no
        WHERE c.user_no = #{userNo}
        ORDER BY c.camp_no DESC;
    </select>
    <select id="campdetailUser" resultType="Camp">
        SELECT *
        FROM campdetail cd
        JOIN campdetailimg cdi ON cd.cp_dt_no = cdi.cp_dt_no
        JOIN (SELECT min(cpdi_no) no FROM campdetailimg GROUP BY cp_dt_no) imgno ON cdi.cpdi_no = imgno.no
        WHERE cd.camp_no = #{campNo}
        ORDER BY cd.camp_no DESC;
    </select>

    <!-- 캠프상품 등록 -->

    <!-- 캠핑장 수정 -->

    <!-- 캠프상품 수정 -->

    <!-- 캠핑장 삭제 -->

    <!-- 캠프상품 삭제-->

    <!-- 오픈일정 가져오기 -->
    <select id="schedule" resultType="Camp">
        SELECT *
        FROM campproduct c
        JOIN campdetail cd ON c.camp_no = cd.camp_no
        JOIN camptype ct ON cd.camptype_no = ct.camptype_no
        JOIN campimg img ON c.camp_no = img.camp_no 
        JOIN (SELECT min(cpi_no) no FROM campimg GROUP BY camp_no) imgno ON img.cpi_no = imgno.no
        WHERE c.camp_open BETWEEN #{campOpen} AND #{campClose}
        ORDER BY c.camp_no DESC;
    </select>
    <!-- 예약일정 가져오기 -->
    <select id="reservation" resultType="Camp">
        SELECT * 
        FROM reservation re
        JOIN campproduct c ON re.camp_no = c.camp_no
        JOIN campimg img ON c.camp_no = img.camp_no 
        JOIN (SELECT min(cpi_no) no FROM campimg GROUP BY camp_no) imgno ON img.cpi_no = imgno.no
        JOIN campdetail cd ON c.camp_no = cd.camp_no
        WHERE re.user_no = #{userNo}
        ORDER BY c.camp_no DESC;
    </select>
    
    <!-- 찜 상품 목록 -->
    <select id="favoritesList" resultType="Camp">
        SELECT * FROM favorites f join campproduct c on f.camp_no = c.camp_no ORDER BY favorites_no DESC
    </select>
    <!-- 찜 상품 삭제 -->
    <delete id="favoriteDelete">
        DELETE FROM favorites WHERE favorites_no = #{favoritesNo}
    </delete>

    <!--캠핑장페이지-->
    <select id="productsimg" resultType="Camp">
        select * from campimg where camp_no = #{campNo}
    </select>
    <select id="productsproducts" resultType="Camp">
        select * from campproduct where camp_no = #{campNo}
    </select>
    <select id="productsreserve">
        select count(*) from reservation where camp_no = #{campNo}
    </select>
    <select id="productsenvironment" resultType="Camp">
        select * from environmenttype t join environment e on t.environmenttype_no = e.environmenttype_no where camp_no = (select camp_no from campproduct where camp_no = #{campNo})
    </select>
    <select id="productsfacility" resultType="Camp">
        select * from facility f join facilitytype ft on f.facilitytype_no = ft.facilitytype_no where f.camp_no =#{campNo}
    </select>
    <select id="productsproductlist" resultType="Camp">
        select * from campdetail cd
        join campdetailimg cdi on cd.cp_dt_no = cdi.cp_dt_no
        join (select min(cpdi_no) no from campdetailimg group by cp_dt_no) cdin on cdi.cpdi_no = cdin.no
        join camptype ct on cd.camptype_no = ct.camptype_no
        where cd.camp_no=#{campNo}
    </select>

    <!-- 캠핑상품 페이지 -->
    <select id="productimg" resultType="Camp">
        select * from campdetailimg where cp_dt_no = #{cpdtNo}
    </select>
    <select id="productintro" resultType="Camp">
        select * from campdetail cd
        left join camptype ct on cd.camptype_no = ct.camptype_no
        left join campproduct c on c.camp_no = cd.camp_no
        where cd.cp_dt_no = #{cpdtNo}
    </select>

    <!-- 예약 페이지 -->
    <select id="reservate" resultType="Camp">
        SELECT * 
        FROM campdetail cd
        JOIN campproduct c ON cd.camp_no = c.camp_no
        JOIN campdetailimg ci ON cd.cp_dt_no = ci.cp_dt_no
        JOIN (SELECT MIN(cpdi_no) cpdi_no FROM campdetailimg GROUP BY cp_dt_no) cn on ci.cpdi_no = cn.cpdi_no
        WHERE cd.cp_dt_no = #{cpdtNo}
    </select>

    <!-- 예약완료페이지 -->
    <select id="reservecomplete" resultType="Camp">
        select ci.cpi_url, c.camp_name, cd.cp_dt_name, r.reservation_no, u.user_name, r.reservation_nop, r.reservation_date, date_format(r.reservation_start, "%Y.%m.%d") reservation_start, date_format(r.reservation_end, "%Y.%m.%d") reservation_end, r.camp_paymenttype
        from reservation r
        left join user u on r.user_no = u.user_no
        left join campproduct c on r.camp_no = c.camp_no
        left join campimg ci on c.camp_no = ci.camp_no
        left join campdetail cd on r.cp_dt_no = cd.cp_dt_no 
        where u.user_id = #{userId}
        order by r.reservation_no desc limit 1
    </select>

    <!--캠핑상품 등록-->
    <insert id="detailinsert">
        INSERT INTO campdetail( camp_no, user_no, cp_dt_name, cp_dt_nop, cp_dt_size, cp_dt_price, camptype_no, cp_dt_introduction )
        VALUES ( #{campNo}, #{userNo}, #{cpdtName}, #{cpdtNop}, #{cpdtSize}, #{cpdtPrice}, #{campTypeNo}, #{cpdtIntroduction} )
    </insert>
    <select id="maxdetailNo" resultType="int">
        select max(cp_dt_no) from campdetail
    </select>
    <insert id="cpdiinsert">
        insert into campdetailimg(cp_dt_no, camp_no, cpdi_url)
        VALUES (#{cpdtNo}, #{campNo}, #{cpdiUrl})
    </insert>

    <!--캠핑상품 수정-->
    <update id="detailupdate">
        update campdetail set cp_dt_name=#{cpdtName}, cp_dt_nop=#{cpdtNop}, cp_dt_size=#{cpdtSize}, cp_dt_price=#{cpdtPrice}, camptype_no=#{campTypeNo}, cp_dt_introduction=#{cpdtIntroduction}
        where cp_dt_no=#{cpdtNo}
    </update>

    <!--캠핑상품 삭제-->
    <delete id="detaildelete">
        delete from campdetail where cp_dt_no = #{cpdtNo}
    </delete>
    <delete id="cpdidelete">
        delete from campdetailimg where cp_dt_no = #{cpdtNo}
    </delete>
    <insert id="detailimginsert">
        insert into campdetailimg()
    </insert>    

    <select id="maxcampNo" resultType="int">
        SELECT MAX(camp_no) FROM campproduct
    </select>
</mapper>